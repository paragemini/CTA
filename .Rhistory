<<<<<<< HEAD
=======
leaflet() %>% addTiles() %>% addPolygons(data = to_geom, weight = 1, fillOpacity = 0)
leaflet() %>% addTiles() %>%
addPolygons(data = total_origin,   fillColor = ~pal(Trips),
weight = 2,opacity = 1,color = "white",
popup = paste0(" TAZ : ", total_origin$Origin, "<br>",
" Trips : ", total_origin$Trips),
dashArray = "3", fillOpacity = 0.7, group = "Origin" ) %>%
addPolygons(data = total_dest,fillColor = ~pal_d(Trips),
popup = paste0(" TAZ : ", total_dest$Destination, "<br>",
" Trips : ", total_dest$Trips),
weight = 2,opacity = 1,color = "white",
dashArray = "3", fillOpacity = 0.7, group = "Destinations" ) %>%
addPolygons(data = tazs_f, weight = 1, fill = NULL, fillOpacity = 0, group = "TAZs") %>%
addLayersControl(overlayGroups = c("Origin", "Destination", "TAZs"))
total_origin <- trips_od %>% group_by(Origin) %>% summarise(Trips = sum(Trips))
total_origin<- st_as_sf(left_join(total_origin, tazs_f,by = c("Origin" = "taz")),
sf_column_name = "geometry", crs =  4326)
total_dest <- trips_od %>% group_by(Destination) %>% summarise(Trips = sum(Trips))
total_dest <- st_as_sf(left_join(total_dest, tazs_f,by = c("Destination" = "taz")),
sf_column_name = "geometry",crs = 4326)
bins <- getBreaks(total_origin$Trips, nclass = 6, method = "jenks")
pal <- colorBin("YlOrRd", domain = total_origin$Trips, bins = bins)
bins_d <- getBreaks(total_dest$Trips, nclass = 6, method = "jenks")
pal_d <- colorBin("YlOrRd", domain = total_dest$Trips, bins = bins)
leaflet() %>% addTiles() %>%
addPolygons(data = total_origin,   fillColor = ~pal(Trips),
weight = 2,opacity = 1,color = "white",
popup = paste0(" TAZ : ", total_origin$Origin, "<br>",
" Trips : ", total_origin$Trips),
dashArray = "3", fillOpacity = 0.7, group = "Origin" ) %>%
addPolygons(data = total_dest,fillColor = ~pal_d(Trips),
popup = paste0(" TAZ : ", total_dest$Destination, "<br>",
" Trips : ", total_dest$Trips),
weight = 2,opacity = 1,color = "white",
dashArray = "3", fillOpacity = 0.7, group = "Destinations" ) %>%
addPolygons(data = tazs_f, weight = 1, fill = NULL, fillOpacity = 0, group = "TAZs") %>%
addLayersControl(overlayGroups = c("Origin", "Destination", "TAZs"))
leaflet() %>% addTiles() %>%
addPolygons(data = total_origin,   fillColor = ~pal(Trips),
weight = 2,opacity = 1,color = "black",
popup = paste0(" TAZ : ", total_origin$Origin, "<br>",
" Trips : ", total_origin$Trips),
dashArray = "3", fillOpacity = 0.7, group = "Origin" ) %>%
addPolygons(data = total_dest,fillColor = ~pal_d(Trips),
popup = paste0(" TAZ : ", total_dest$Destination, "<br>",
" Trips : ", total_dest$Trips),
weight = 2,opacity = 1,color = "black",
dashArray = "3", fillOpacity = 0.7, group = "Destinations" ) %>%
addPolygons(data = tazs_f, weight = 1, fill = NULL, fillOpacity = 0, group = "TAZs") %>%
addLayersControl(overlayGroups = c("Origin", "Destination", "TAZs"))
leaflet() %>% addTiles() %>%
addPolygons(data = total_origin,   fillColor = ~pal(Trips),
weight = 1,opacity = 1,color = "black",
popup = paste0(" TAZ : ", total_origin$Origin, "<br>",
" Trips : ", total_origin$Trips),
fillOpacity = 0.7, group = "Origin" ) %>%
addPolygons(data = total_dest,fillColor = ~pal_d(Trips),
popup = paste0(" TAZ : ", total_dest$Destination, "<br>",
" Trips : ", total_dest$Trips),
weight = 1,opacity = 1,color = "black",
fillOpacity = 0.7, group = "Destinations" ) %>%
addPolygons(data = tazs_f, weight = 1, fill = NULL, fillOpacity = 0, group = "TAZs") %>%
addLayersControl(overlayGroups = c("Origin", "Destination", "TAZs"))
leaflet() %>% addTiles() %>%
addPolygons(data = total_origin,   fillColor = ~pal(Trips),
weight = 1,opacity = 1,color = "black",
popup = paste0(" TAZ : ", total_origin$Origin, "<br>",
" Trips : ", total_origin$Trips),
fillOpacity = 0.7, group = "Origin" ) %>%
addPolygons(data = total_dest,fillColor = ~pal_d(Trips),
popup = paste0(" TAZ : ", total_dest$Destination, "<br>",
" Trips : ", total_dest$Trips),
weight = 1,opacity = 1,color = "black",
fillOpacity = 0.7, group = "Destination" ) %>%
addPolygons(data = tazs_f, weight = 1, fill = NULL, fillOpacity = 0, group = "TAZs") %>%
addLayersControl(overlayGroups = c("Origin", "Destination", "TAZs"))
trips_od_f <-   trips_od[ trips_od$Origin == "1208500160", ]
properties <- list(
getWidth = 2,
getSourcePosition = ~o_long + o_lat,
getTargetPosition = ~d_long+ d_lat,
getSourceColor = JS("d => [Math.sqrt(d.Trips), 140, 0]"),
getTargetColor = JS("d => [Math.sqrt(d.outbound), 140, 0]"),
tooltip = use_tooltip(
html = " Trip : {{Origin}} to {{Destination}}<br>
Total Trips : {{Trips}}",
style = "background: steelBlue; border-radius: 5px;"
)
)
props = list(
getPolygon = JS("d => d.geometry.coordinates"),
pickable = TRUE,
stroked = TRUE,
filled = TRUE,
wireframe = TRUE,
opacity = 0.1,
getLineWidth = 2,
getLineColor = "blue",
lineWidthMinPixels = 1,
tooltip = "TAZ : {{taz}}"# !!!
)
deckgl(zoom = 10, pitch = 35) %>%
add_arc_layer(data = trips_od_f, properties = properties) %>%
add_polygon_layer(data = tazs_f, properties = props) %>%
add_basemap(use_carto_style("positron"))
trips_od_f <-   trips_od[ trips_od$Origin == "12085001601", ]
properties <- list(
getWidth = 2,
getSourcePosition = ~o_long + o_lat,
getTargetPosition = ~d_long+ d_lat,
getSourceColor = JS("d => [Math.sqrt(d.Trips), 140, 0]"),
getTargetColor = JS("d => [Math.sqrt(d.outbound), 140, 0]"),
tooltip = use_tooltip(
html = " Trip : {{Origin}} to {{Destination}}<br>
Total Trips : {{Trips}}",
style = "background: steelBlue; border-radius: 5px;"
)
)
props = list(
getPolygon = JS("d => d.geometry.coordinates"),
pickable = TRUE,
stroked = TRUE,
filled = TRUE,
wireframe = TRUE,
opacity = 0.1,
getLineWidth = 2,
getLineColor = "blue",
lineWidthMinPixels = 1,
tooltip = "TAZ : {{taz}}"# !!!
)
deckgl(zoom = 10, pitch = 35) %>%
add_arc_layer(data = trips_od_f, properties = properties) %>%
add_polygon_layer(data = tazs_f, properties = props) %>%
add_basemap(use_carto_style("positron"))
props = list(
getPolygon = JS("d => d.geometry.coordinates"),
pickable = TRUE,
stroked = TRUE,
filled = TRUE,
getFillColor = "white",
wireframe = TRUE,
opacity = 0.1,
getLineWidth = 2,
getLineColor = "blue",
lineWidthMinPixels = 1,
tooltip = "TAZ : {{taz}}"# !!!
)
deckgl(zoom = 10, pitch = 35) %>%
add_arc_layer(data = trips_od_f, properties = properties) %>%
add_polygon_layer(data = tazs_f, properties = props) %>%
add_basemap(use_carto_style("positron"))
od_map <- leaflet() %>% addTiles() %>%
addPolygons(data = total_origin,   fillColor = ~pal(Trips),
weight = 1,opacity = 1,color = "black",
popup = paste0(" TAZ : ", total_origin$Origin, "<br>",
" Trips : ", total_origin$Trips),
fillOpacity = 0.7, group = "Origin" ) %>%
addPolygons(data = total_dest,fillColor = ~pal_d(Trips),
popup = paste0(" TAZ : ", total_dest$Destination, "<br>",
" Trips : ", total_dest$Trips),
weight = 1,opacity = 1,color = "black",
fillOpacity = 0.7, group = "Destination" ) %>%
addPolygons(data = tazs_f, weight = 1, fill = NULL, fillOpacity = 0, group = "TAZs") %>%
addLayersControl(overlayGroups = c("Origin", "Destination", "TAZs"))
library(htmlwidgets)
saveWidget(od_map, "OD_map_externals.html")
getwd()
save.image("arclayer-od-map.Rdata")
getwd()
library(shiny); runApp('C:/Users/gupta/Dropbox/iqc/UX_RSLAM_v2.R')
install.packages("rJava")
runApp('C:/Users/gupta/Dropbox/iqc/UX_RSLAM_v2.R')
library(sf)
library(data.table)
library(lehdr)
library(tidycensus)
library(stringr)
library(dplyr)
library(leaflet)
library(tidyr)
library(htmltools)
library(leaflet)
library(rvest)
library(lubridate)
library(purrr)
library(leafgl)
library(tigris)
#library(deckgl)
library(rdeck)
library(sfheaders)
library(rjson)
library(httr)
library(RCurl)
#unique shapes 1658
setwd("D:\\PASSION_PROJECTS\\cta\\CTA")
>>>>>>> ee3fde5e3ae4dc71d76eb5a59a8bfa7362fa3ca8
#setwd("/Users/parag.geminigmail.com/Documents/CTA")
### main statsistics file #############
#tripsByRoute,
#tripsByUniqueStopsRoutes ,
#tripsByTotalStopsRoutes
# View(tripsByRoute)
# View(tripsByUniqueStopsRoutes)
# View(tripsByTotalStopsRoutes)
######## writting own summary function #####
sum_detail <- function(d_frame){
message(str_c("Total Columns : ", ncol(d_frame),
" ; Total Rows : ", nrow(d_frame)))
message(str_c(  "Column Names : ", paste0(colnames(d_frame), collapse = " , ")))
i <- 1
x <- lapply(d_frame, function(x){
if(length(unique(x)) >= 3 ) {
message( str_c( "Name " , i," : ", colnames(d_frame)[i],
" ; Length Unique : ",length(unique(x)),
" ; Values : ", paste0(unique(x)[1:3], collapse = ",") ))
} else {
message( str_c( "Name " , i," : ", colnames(d_frame)[i],
" ; Length Unique  : ",length(unique(x)),
" ; Values : ", paste0(unique(x), collapse = ",")))
}
i <<- i + 1
})
}
scrape_stops <- function(){
routes_f <- routes[ route_type == 3, ]
stops_list <- lapply(1:nrow(routes_f), sum)
stops_list <-   map(1:nrow(routes_f),possibly(
function(x){
print(  str_c(x , " : ", routes_f$route_long_name[x]))
l <- html_table(read_html(str_c("https://www.transitchicago.com/assets/1/6/stoplist_",
routes_f$route_short_name[x],".htm")), header = T)
l[[1]]$route_long_name <- routes_f$route_long_name[x]
l[[1]]$route_short_name <- routes_f$route_short_name[x]
stops_list[[x]] <- l[[1]]
},
otherwise = NA_real_))
names(stops_list) <- routes_f$route_short_name
flat_stops <-  setDT(do.call(rbind.data.frame, stops_list))
return(flat_stops)
}
###### reading files #########
#transfers <- read.csv("transfers.csv")
<<<<<<< HEAD
files_paths <- list.files("C:\\Users\\pgupta\\CTA\\google_transit", full.names = T)
files_names <- list.files("C:\\Users\\pgupta\\CTA\\google_transit")
# files_paths <- list.files("./google_transit", full.names = T)
# files_names <- list.files("./google_transit")
=======
# files_paths <- list.files("C:\\Users\\pgupta\\CTA\\google_transit", full.names = T)
# files_names <- list.files("C:\\Users\\pgupta\\CTA\\google_transit")
files_paths <- list.files("./google_transit", full.names = T)
files_names <- list.files("./google_transit")
>>>>>>> ee3fde5e3ae4dc71d76eb5a59a8bfa7362fa3ca8
files <- lapply(files_paths, fread)
names(files) <- gsub(pattern = "\\.txt$", replacement = "", x = files_names)
cta_data <- files
### getting GTFS feed separately
routes <- cta_data[["routes"]]
trips <- cta_data[["trips"]]
calendar <- cta_data[["calendar"]]
for( i in 1:nrow(calendar)){
print(i)
days <-  setDT(list(colnames(calendar[,2:8])[which(calendar[i,2:8] == 1)]))
nickDays <- data.frame(V1 = colnames(calendar[1,2:8]),
V2 = c("M","T","W","R","F","SA","SU"))
days <- left_join(days,nickDays, by = "V1" )
calendar$Days[i] <- paste0(days$V2, collapse = ",")
}
stops <- cta_data[["stops"]]
stop_times <- cta_data[["stop_times"]]
shapes <- cta_data[["shapes"]]
#### creating all shapes from shapes.txt by shape_id ############
shape_split <- split(shapes, shapes$shape_id)
shape_geom <- lapply(1:length(shape_split), sum)
for( i in 1:length(shape_split)){
print(i)
shape_geom[[i]] <- st_linestring(as.matrix(shape_split[[i]][ , c(3,2)]))
}
trip_shapes <-st_sf(data.frame(shape_id = names(shape_split),
geometry = st_sfc(shape_geom)), sf_column_name = "geometry",
crs = 4326)
trip_shapes <- left_join(trip_shapes, shapes[ , .(total_distance_ft = shape_dist_traveled[.N]) ,
by = list(shape_id)], by = "shape_id")
trip_shapes$length_mi <- st_length(trip_shapes)/1609.34
<<<<<<< HEAD
View(trip_shapes)
leaflet() %>% addTiles() %>% addPolylines(data = trip_shapes[trip_shapes$shape_id == "306800035",])
25/3
0.33 * 60
leaflet() %>% addTiles() %>% addPolylines(data = trip_shapes[trip_shapes$shape_id == "64802946",])
library(sf)
library(data.table)
library(lehdr)
library(tidycensus)
library(stringr)
library(dplyr)
library(leaflet)
library(tidyr)
library(htmltools)
library(leaflet)
library(rvest)
library(lubridate)
library(purrr)
library(leafgl)
library(tigris)
library(deckgl)
#library(rdeck)
library(sfheaders)
files_paths <- list.files("C:\\Users\\pgupta\\CTA\\google_transit", full.names = T)
files_names <- list.files("C:\\Users\\pgupta\\CTA\\google_transit")
files <- lapply(files_paths, fread)
names(files) <- gsub(pattern = "\\.txt$", replacement = "", x = files_names)
cta_data <- files
# assigning all the value to the variables
routes <- cta_data[["routes"]]
trips <- cta_data[["trips"]]
calendar <- cta_data[["calendar"]]
stops <- cta_data[["stops"]]
stop_times <- cta_data[["stop_times"]]
shapes <- cta_data[["shapes"]]
#getting one master file
master_file <- left_join(
left_join(
left_join(stop_times,
trips[ , c(1,2,3,6,7)],
by = "trip_id"), stops[,c(1,3,5,6)],
by = "stop_id"), calendar[,c(1:10)], by = "service_id")
#functions
return_tod <- function(day_one, type_of_day){
if(type_of_day != "saturday" & type_of_day != "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 6, "Early AM",
if_else(start_local_hour >= 6 &
start_local_hour < 9, "AM-Peak",
if_else(start_local_hour >= 9 &
start_local_hour < 15, "Midday",
if_else(start_local_hour >= 15 &
start_local_hour < 19, "PM-Peak",
if_else(start_local_hour >= 19 &
start_local_hour < 23, "Evening", "Late-Night"
)
} else if(type_of_day == "saturday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 8, "SAT-AM",
if_else(start_local_hour >= 8 &
start_local_hour < 20, "SAT-MD",
if_else(start_local_hour >= 20 , "SAT-PM", "Late-Night"
)
} else if(type_of_day == "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 0 &
start_local_hour < 5, "SUN-EA",
if_else(start_local_hour >= 5 &
start_local_hour < 9, "SUN-AM",
if_else(start_local_hour >= 9 &
start_local_hour < 18, "SUN-MD", "SUN-PM"
)
}
return(day_tod)
}
return_routes_time <- function( master_f){
days <- c("monday","tuesday","wednesday","thursday",
"friday","saturday","sunday")
days_split <- lapply(days, function(x){
day_one <-   master_f[master_f[[x]] == 1,]
day_one <- return_tod(day_one = day_one, type_of_day = x)
return(day_one)
})
names(days_split) <- days
i <- 0
expt_2 <- lapply(days_split, function(x){
i <<- i + 1
return(
x[ , .(Min_Stop_Sequence = min(stop_sequence),
Max_Stop_Sequence = max(stop_sequence),
Min_Arrival_Time = min(start_time),
Max_Departure_Time = max(end_time),
trips = length(unique(trip_id)),
trp_ids = trip_id[which.max(stop_sequence)],
max_shape_id = shape_id[which.max(stop_sequence)],
max_shape_distance = shape_dist_traveled[which.max(stop_sequence)],
Day = days[i]
),
by = list(route_id, direction, TOD)][ ,
`:=`(Min_Arrival_Time = str_pad(Min_Arrival_Time,6,side = "left",pad = "0"),
Max_Departure_Time = str_pad(Max_Departure_Time,6,side = "left",pad = "0")),]
)
})
return(expt_2)
}
#calculating time range per route
master_f <- master_file[ end_date != 20220611  , , ][ , `:=`(
start_time = as.numeric(gsub(arrival_time,pattern = ":",replacement = "")),
end_time =  as.numeric(gsub(departure_time,pattern = ":",replacement = "")),
start_local_hour = as.numeric(str_sub( arrival_time,1,2))
)]
routes_time <-  return_routes_time(master_f = master_f)
routes_daily_stats <- setDT(do.call(rbind.data.frame, routes_time))
routes_daily_stats[ , Day_Type := if_else(Day != "saturday" & Day != "sunday" , "Wkdy","Wknd"), ]
View(routes_daily_stats)
View(trip_shapes)
View(stop_times)
stops_trips <- stop_times[(stop_times$trip_id %in% routes_daily_stats$trp_ids), c(1,4,5,6)]
View(stops_trips)
View(stops)
View(stops_trips)
stops_trips <- left_join(stop_times[(stop_times$trip_id %in% routes_daily_stats$trp_ids), c(1,4,5,6)],
stops[ , c(1,3,5,6), by = "stop_id"])
stops_trips <- left_join(stop_times[(stop_times$trip_id %in% routes_daily_stats$trp_ids), c(1,4,5,6)],
stops[ , c(1,3,5,6)],  by = "stop_id")
View(stops_trips)
class(routes_daily_stats)
routes_daily_stats <- left_join(routes_daily_stats, shapes, by = "shape_id")
routes_time <-  return_routes_time(master_f = master_f)
routes_daily_stats <- setDT(do.call(rbind.data.frame, routes_time))
routes_daily_stats[ , Day_Type := if_else(Day != "saturday" & Day != "sunday" , "Wkdy","Wknd"), ]
View(routes_daily_stats)
library(sf)
library(data.table)
library(lehdr)
library(tidycensus)
library(stringr)
library(dplyr)
library(leaflet)
library(tidyr)
library(htmltools)
library(leaflet)
library(rvest)
library(lubridate)
library(purrr)
library(leafgl)
library(tigris)
library(deckgl)
#library(rdeck)
library(sfheaders)
files_paths <- list.files("C:\\Users\\pgupta\\CTA\\google_transit", full.names = T)
files_names <- list.files("C:\\Users\\pgupta\\CTA\\google_transit")
files <- lapply(files_paths, fread)
names(files) <- gsub(pattern = "\\.txt$", replacement = "", x = files_names)
cta_data <- files
# assigning all the value to the variables
routes <- cta_data[["routes"]]
trips <- cta_data[["trips"]]
calendar <- cta_data[["calendar"]]
stops <- cta_data[["stops"]]
stop_times <- cta_data[["stop_times"]]
shapes <- cta_data[["shapes"]]
#getting one master file
master_file <- left_join(
left_join(
left_join(stop_times,
trips[ , c(1,2,3,6,7)],
by = "trip_id"), stops[,c(1,3,5,6)],
by = "stop_id"), calendar[,c(1:10)], by = "service_id")
#functions
return_tod <- function(day_one, type_of_day){
if(type_of_day != "saturday" & type_of_day != "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 6, "Early AM",
if_else(start_local_hour >= 6 &
start_local_hour < 9, "AM-Peak",
if_else(start_local_hour >= 9 &
start_local_hour < 15, "Midday",
if_else(start_local_hour >= 15 &
start_local_hour < 19, "PM-Peak",
if_else(start_local_hour >= 19 &
start_local_hour < 23, "Evening", "Late-Night"
)
} else if(type_of_day == "saturday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 8, "SAT-AM",
if_else(start_local_hour >= 8 &
start_local_hour < 20, "SAT-MD",
if_else(start_local_hour >= 20 , "SAT-PM", "Late-Night"
)
} else if(type_of_day == "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 0 &
start_local_hour < 5, "SUN-EA",
if_else(start_local_hour >= 5 &
start_local_hour < 9, "SUN-AM",
if_else(start_local_hour >= 9 &
start_local_hour < 18, "SUN-MD", "SUN-PM"
)
}
return(day_tod)
}
return_routes_time <- function( master_f){
days <- c("monday","tuesday","wednesday","thursday",
"friday","saturday","sunday")
days_split <- lapply(days, function(x){
day_one <-   master_f[master_f[[x]] == 1,]
day_one <- return_tod(day_one = day_one, type_of_day = x)
return(day_one)
})
names(days_split) <- days
i <- 0
expt_2 <- lapply(days_split, function(x){
i <<- i + 1
return(
x[ , .(Min_Stop_Sequence = min(stop_sequence),
Max_Stop_Sequence = max(stop_sequence),
Min_Arrival_Time = min(start_time),
Max_Departure_Time = max(end_time),
trips = length(unique(trip_id)),
trp_ids = trip_id[which.max(stop_sequence)],
max_shape_id = shape_id[which.max(stop_sequence)],
max_shape_distance = shape_dist_traveled[which.max(stop_sequence)],
Day = days[i]
),
by = list(route_id, direction, TOD)][ ,
`:=`(Min_Arrival_Time = str_pad(Min_Arrival_Time,6,side = "left",pad = "0"),
Max_Departure_Time = str_pad(Max_Departure_Time,6,side = "left",pad = "0")),]
)
})
return(expt_2)
}
#calculating time range per route
master_f <- master_file[ end_date != 20220611  , , ][ , `:=`(
start_time = as.numeric(gsub(arrival_time,pattern = ":",replacement = "")),
end_time =  as.numeric(gsub(departure_time,pattern = ":",replacement = "")),
start_local_hour = as.numeric(str_sub( arrival_time,1,2))
)]
routes_time <-  return_routes_time(master_f = master_f)
routes_daily_stats <- setDT(do.call(rbind.data.frame, routes_time))
routes_daily_stats[ , Day_Type := if_else(Day != "saturday" & Day != "sunday" , "Wkdy","Wknd"), ]
routes_daily_stats <- left_join(routes_daily_stats, shapes, by = c("max_shape_id"= "shape_id"))
stops_trips <- left_join(stop_times[(stop_times$trip_id %in% routes_daily_stats$trp_ids), c(1,4,5,6)],
stops[ , c(1,3,5,6)],  by = "stop_id")
class(routes_daily_stats)
?st_as_sf
View(shapes)
routes_daily_stats <- st_as_sf(left_join(routes_daily_stats, trip_shapes, by = c("max_shape_id"= "shape_id")),
sf_column_name = "geometry", crs = 4326)
routes_daily_stats <- st_as_sf(left_join(routes_daily_stats, trip_shapes, by = c("max_shape_id"= "shape_id")),
sf_column_name = "geometry", crs = 4326)
stops_trips <- left_join(stop_times[(stop_times$trip_id %in% routes_daily_stats$trp_ids), c(1,4,5,6)],
stops[ , c(1,3,5,6)],  by = "stop_id")
library(sf)
library(data.table)
library(lehdr)
library(tidycensus)
library(stringr)
library(dplyr)
library(leaflet)
library(tidyr)
library(htmltools)
library(leaflet)
library(rvest)
library(lubridate)
library(purrr)
library(leafgl)
library(tigris)
library(deckgl)
#library(rdeck)
library(sfheaders)
files_paths <- list.files("C:\\Users\\pgupta\\CTA\\google_transit", full.names = T)
files_names <- list.files("C:\\Users\\pgupta\\CTA\\google_transit")
files <- lapply(files_paths, fread)
names(files) <- gsub(pattern = "\\.txt$", replacement = "", x = files_names)
cta_data <- files
# assigning all the value to the variables
routes <- cta_data[["routes"]]
trips <- cta_data[["trips"]]
calendar <- cta_data[["calendar"]]
stops <- cta_data[["stops"]]
stop_times <- cta_data[["stop_times"]]
shapes <- cta_data[["shapes"]]
#getting one master file
master_file <- left_join(
left_join(
left_join(stop_times,
trips[ , c(1,2,3,6,7)],
by = "trip_id"), stops[,c(1,3,5,6)],
by = "stop_id"), calendar[,c(1:10)], by = "service_id")
#functions
return_tod <- function(day_one, type_of_day){
if(type_of_day != "saturday" & type_of_day != "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 6, "Early AM",
if_else(start_local_hour >= 6 &
start_local_hour < 9, "AM-Peak",
if_else(start_local_hour >= 9 &
start_local_hour < 15, "Midday",
if_else(start_local_hour >= 15 &
start_local_hour < 19, "PM-Peak",
if_else(start_local_hour >= 19 &
start_local_hour < 23, "Evening", "Late-Night"
)
} else if(type_of_day == "saturday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 8, "SAT-AM",
if_else(start_local_hour >= 8 &
start_local_hour < 20, "SAT-MD",
if_else(start_local_hour >= 20 , "SAT-PM", "Late-Night"
)
} else if(type_of_day == "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 0 &
start_local_hour < 5, "SUN-EA",
if_else(start_local_hour >= 5 &
start_local_hour < 9, "SUN-AM",
if_else(start_local_hour >= 9 &
start_local_hour < 18, "SUN-MD", "SUN-PM"
)
}
return(day_tod)
}
return_routes_time <- function( master_f){
days <- c("monday","tuesday","wednesday","thursday",
"friday","saturday","sunday")
days_split <- lapply(days, function(x){
day_one <-   master_f[master_f[[x]] == 1,]
day_one <- return_tod(day_one = day_one, type_of_day = x)
return(day_one)
})
names(days_split) <- days
i <- 0
expt_2 <- lapply(days_split, function(x){
i <<- i + 1
return(
x[ , .(Min_Stop_Sequence = min(stop_sequence),
Max_Stop_Sequence = max(stop_sequence),
Min_Arrival_Time = min(start_time),
Max_Departure_Time = max(end_time),
trips = length(unique(trip_id)),
trp_ids = trip_id[which.max(stop_sequence)],
max_shape_id = shape_id[which.max(stop_sequence)],
max_shape_distance = shape_dist_traveled[which.max(stop_sequence)],
Day = days[i]
),
by = list(route_id, direction, TOD)][ ,
`:=`(Min_Arrival_Time = str_pad(Min_Arrival_Time,6,side = "left",pad = "0"),
Max_Departure_Time = str_pad(Max_Departure_Time,6,side = "left",pad = "0")),]
)
})
return(expt_2)
}
#calculating time range per route
master_f <- master_file[ end_date != 20220611  , , ][ , `:=`(
start_time = as.numeric(gsub(arrival_time,pattern = ":",replacement = "")),
end_time =  as.numeric(gsub(departure_time,pattern = ":",replacement = "")),
start_local_hour = as.numeric(str_sub( arrival_time,1,2))
)]
routes_time <-  return_routes_time(master_f = master_f)
routes_daily_stats <- setDT(do.call(rbind.data.frame, routes_time))
routes_daily_stats[ , Day_Type := if_else(Day != "saturday" & Day != "sunday" , "Wkdy","Wknd"), ]
routes_daily_stats_shapes <- left_join(routes_daily_stats, trip_shapes, by = c("max_shape_id"= "shape_id"))
stops_trips <- left_join(stop_times[(stop_times$trip_id %in% routes_daily_stats$trp_ids), c(1,4,5,6)],
stops[ , c(1,3,5,6)],  by = "stop_id")
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes)
routes_daily_stats_shapes <-st_as_sf(left_join(routes_daily_stats, trip_shapes,
by = c("max_shape_id"= "shape_id")),
crs = 4326, sf_column_name = "geometry")
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes)
setDT(unique(routes_daily_stats$max_shape_id))
setDT(list(unique(routes_daily_stats$max_shape_id)))
shapes_routes <- setDT(list(unique(routes_daily_stats$max_shape_id)))
View(shapes_routes)
View(trip_shapes)
shapes_routes <- setDT(list(unique(routes_daily_stats$max_shape_id)))
routes_daily_stats_shapes <-st_as_sf(left_join(shapes_routes, trip_shapes,
by = c("V1"= "shape_id")),
crs = 4326, sf_column_name = "geometry")
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes)
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes) %>%
addCircleMarkers(data = stops_trips, lng = stops_trips$stop_lon,
lat = stops_trips$stop_lon)
View(stops_trips)
View(stop_times)
stops_trips <- setDT(unique(stop_times$stop_id[(stop_times$trip_id %in% routes_daily_stats$trp_ids)]))
stops_trips <- setDT(list(unique(stop_times$stop_id[(stop_times$trip_id %in% routes_daily_stats$trp_ids)])))
View(stops_trips)
stops_trips <- left_join(stops_tripd,
stops[ , c(1,3,5,6)],  by =c("V1" = "stop_id"))
View(stops)
stops_trips <- left_join(stops_trips,
stops[ , c(1,3,5,6)],
by =c("V1" = "stop_id"))
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes) %>%
addCircleMarkers(data = stops_trips, lng = stops_trips$stop_lon,
lat = stops_trips$stop_lon)
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes) %>%
addCircleMarkers(data = stops_trips)
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes) %>%
addCircleMarkers(data = stops_trips,
lat = stops_trips$stop_lat, lng = stops_trips$stop_lon)
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes, weight = 1) %>%
addCircleMarkers(data = stops_trips,
lat = stops_trips$stop_lat, lng = stops_trips$stop_lon,
radius = 2)
?blocks
b_17031 <- blocks(state = "17", county = "031", year = 2021)
leaflet() %>% addTiles() %>%
addPolylines(data = routes_daily_stats_shapes, weight = 1) %>%
addCircleMarkers(data = stops_trips,
lat = stops_trips$stop_lat, lng = stops_trips$stop_lon,
radius = 2) %>%
addPolygons(data = st_transform(b_17031, 4326), weight = 1,
fillOpacity = 0)
rm(list = ls())
gc()
=======
rm(list = setdiff(ls(), "trip_shapes"))
gc()
library(sf)
library(data.table)
library(lehdr)
library(tidycensus)
library(stringr)
library(dplyr)
library(leaflet)
library(tidyr)
library(htmltools)
library(leaflet)
library(rvest)
library(lubridate)
library(purrr)
library(leafgl)
library(tigris)
library(deckgl)
#library(rdeck)
library(sfheaders)
library(tigris)
library(mapdeck)
setwd("D:\\PASSION_PROJECTS\\cta\\CTA")
# files_paths <- list.files("C:\\Users\\pgupta\\CTA\\google_transit", full.names = T)
# files_names <- list.files("C:\\Users\\pgupta\\CTA\\google_transit")
files_paths <- list.files("D:\\PASSION_PROJECTS\\cta\\CTA\\google_transit", full.names = T)
files_names <- list.files("D:\\PASSION_PROJECTS\\cta\\CTA\\google_transit")
files <- lapply(files_paths, fread)
names(files) <- gsub(pattern = "\\.txt$", replacement = "", x = files_names)
cta_data <- files
tod_hours <- read.csv("tod-hours.csv")
tod_hours$PERIOD <- gsub(tod_hours$PERIOD, pattern = "_", replacement = "-")
# assigning all the value to the variables
routes <- cta_data[["routes"]]
trips <- cta_data[["trips"]]
calendar <- cta_data[["calendar"]]
stops <- cta_data[["stops"]]
stop_times <- cta_data[["stop_times"]]
shapes <- cta_data[["shapes"]]
#
#functions for analysis
return_tod <- function(day_one, type_of_day){
if(type_of_day != "saturday" & type_of_day != "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 6, "Early-AM",
if_else(start_local_hour >= 6 &
start_local_hour < 9, "AM-Peak",
if_else(start_local_hour >= 9 &
start_local_hour < 15, "Midday",
if_else(start_local_hour >= 15 &
start_local_hour < 19, "PM-Peak",
if_else(start_local_hour >= 19 &
start_local_hour < 23, "Evening", "Late-Night"
)
)
)
)
)
)
} else if(type_of_day == "saturday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 4 &
start_local_hour < 8, "SAT-AM",
if_else(start_local_hour >= 8 &
start_local_hour < 20, "SAT-MD",
if_else(start_local_hour >= 20 , "SAT-PM", "SAT-Late-Night"
)
)
)
)
} else if(type_of_day == "sunday"){
day_tod <- day_one %>%
mutate(TOD = if_else(start_local_hour >= 0 &
start_local_hour < 5, "SUN-EA",
if_else(start_local_hour >= 5 &
start_local_hour < 9, "SUN-AM",
if_else(start_local_hour >= 9 &
start_local_hour < 18, "SUN-MD", "SUN-PM"
)
)
)
)
}
return(day_tod)
}
return_routes_time <- function( master_f){
message("Getting all the trips and stop sequences by day")
days <- c("monday","tuesday","wednesday","thursday",
"friday","saturday","sunday")
days_split <- lapply(days, function(x){
day_one <-   master_f[master_f[[x]] == 1,]
day_one <- return_tod(day_one = day_one, type_of_day = x)
day_one$Day <- x
return(day_one)
})
message("Got all the trips")
names(days_split) <- days
return(days_split)
message("Conveting now int to double")
days_split <- lapply(days_split, function(y){
setDT(lapply(y,
function(x){
if(is.integer(x)){
return(as.double(x))
} else {
return(x)
}
}))
})
message("Converted everything int to double")
message("Calculate stats")
i <- 0
expt_2 <- lapply(days_split, function(x){
i <<- i + 1
return(
x[ , .(Min_Stop_Sequence = min(stop_sequence),
Max_Stop_Sequence = max(stop_sequence),
Min_Arrival_Time = min(start_time),
Max_Departure_Time = max(end_time),
trips =  length(trip_id[stop_sequence == 1]),
dist_travelled = sum(Distance[stop_sequence == 1]),
max_dist_travelled = max(Distance[stop_sequence == 1]),
min_dist_travelled = min(Distance[stop_sequence == 1]),
median_dist_travelled = median(Distance[stop_sequence == 1]),
trp_ids = trip_id[which.max(stop_sequence)],
max_shape_id = shape_id[which.max(stop_sequence)],
Day = days[i]
),
by = list(route_id, TOD, direction)][ ,
`:=`(Min_Arrival_Time = str_pad(Min_Arrival_Time,6,side = "left",pad = "0"),
Max_Departure_Time = str_pad(Max_Departure_Time,6,side = "left",pad = "0")),]
)
})
message("Finished Stats and now Rbinding")
routes_time <- do.call(rbind.data.frame, expt_2)
return(routes_time)
}
#getting trips stats from stop_times file
insert_comma <- function(st_vector){
new_st_vector <-  str_c(str_sub(st_vector,1,2),":", str_sub(st_vector,3,4), ":",
str_sub(st_vector,5,6))
return(new_st_vector)
}
stop_times[ , `:=`(start_time = gsub(arrival_time, pattern = ":", replacement = ""),
end_time = gsub(departure_time, pattern = ":", replacement = "")) , ]
trips_stats <- stop_times[ , .(Distance = shape_dist_traveled[which.max(stop_sequence)] ,
Total_Stops = stop_sequence[which.max(stop_sequence)],
Min_Arrival_Time = min(start_time),
Max_Departure_Time = max(end_time)),
by = list(trip_id)][,
`:=`(arrival =hms(insert_comma(Min_Arrival_Time)),
departure = hms(insert_comma(Max_Departure_Time))),
][ ,`:=`(duration= seconds(departure - arrival),
start_local_hour = hour(arrival)), ][ , duration:= as.numeric(duration), ]
trips_stats_meta<- setDT(left_join(
left_join(trips[,c(1,2,3,6,7)],
trips_stats,
by = "trip_id"), calendar[,c(1:10)],
by = "service_id"))
trips_stats_meta_f <- as.data.frame(trips_stats_meta[end_date != 20220611,])
trips_day <- return_routes_time(trips_stats_meta_f)
trips_day_df <- do.call(rbind.data.frame, trips_day)
tuesday <- setDT(list(  trips_day_df$trip_id[trips_day_df$Day == "tuesday"]))
tuesday <- left_join(  tuesday,
trips_stats_meta_f[,-c(10,11,14:22)],
by = c("V1" = "trip_id"))
tuesday[ , `:=`(start_local_mins = as.numeric(str_sub(Min_Arrival_Time,3,4)),
start_local_secs = as.numeric(str_sub(Min_Arrival_Time,5,6))), ][ ,
`:=`(start_secs = start_local_hour * 60 * 60 +
start_local_mins * 60 +
start_local_secs ), ][ , end_secs:= start_secs + duration, ]
tuesday_sf <- left_join(tuesday,
trip_shapes,
by = "shape_id")
tueday_trips <-  lapply(1:nrow(tuesday_sf), sum)
for( i in 1:length(1:nrow(tuesday_sf))){ #:
print(i)
paths <- data.frame(Z = rep(0, nrow(tuesday_sf$geometry[[i]][ , c(1,2)])),
start_secs = tuesday_sf$start_secs[i],
ends_secs = tuesday_sf$end_secs[i],
duration = tuesday_sf$duration[i])
x <-  cbind(tuesday_sf$geometry[[i]][ , c(1,2)],paths)
x$interval <-  x$duration/nrow(x)
x$sequence <- 1:nrow(x)
colnames(x)[1:2] <- c("X","Y")
x$M <- x$start_secs + x$interval * x$sequence
x_f <- setDT(x[ , c(1,2,3,9)])
tueday_trips[[i]] <- st_linestring(as.matrix(x_f))
}
names(tueday_trips) <- tuesday_sf$V1
all_tues_trip <- data.frame(ID = tuesday_sf$V1)
all_tues_trip$geometry <- tueday_trips
all_tues_trip <- st_as_sf(all_tues_trip, sf_column_name = "geometry",
crs = 4326)
#[route_color == "565a5c" , route_color:= "ffffff" ,]
routes[ , route_color:= str_c("#", route_color), ]
all_tues_trip <- left_join(left_join(all_tues_trip,
tuesday[,c(1,2)],
by = c("ID" = "V1")),
routes[,c(1,6)],
by = "route_id")
all_tues_trip_one <- split(all_tues_trip,
all_tues_trip$route_color)
trips_map <- mapdeck(
location = c( -87.62963419064182,41.88243038220215) ,
zoom = 10,
style = mapdeck_style("light")
)
trips_map <- trips_map %>% add_trips(
layer_id = str_c("5"),
data = all_tues_trip_one[[5]][1:12500,],
stroke_colour = "#6E85B7",
start_time = 0,
end_time = 90300,
trail_length = 400,
animation_speed = 400,
stroke_width = 100,
opacity = 0.2
)
for( i in c(1:11)){
if(i != 5) {
trips_map <- trips_map %>%
add_trips(
layer_id = str_c(i),
data = all_tues_trip_one[[i]],
stroke_colour = names(all_tues_trip_one)[i],
start_time = 0,
end_time = 90300,
trail_length = 500,
animation_speed = 400,
stroke_width = 100
)
}
}
trips_map
>>>>>>> ee3fde5e3ae4dc71d76eb5a59a8bfa7362fa3ca8
